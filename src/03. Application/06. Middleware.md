# Middleware

The first component in the Asp.NET Core pipeline is `Middleware`. Middleware can either handle a request completely, or process the incoming request and pass it on to the next component in the pipeline.

As Piranha CMS is built around standard `ASP.NET` components most of its middleware is used for routing and passes the request on to eventually be handled by the web application.

## Registering The Middleware

The middleware components are added when configuring the application in `Startup.cs`. The following code sets up middleware for all available content.

### Standard Setup

~~~ csharp
public void Configure(IApplicationBuilder app, IHostingEnvironment env, IApi api)
{
    ...

    // Configure Piranha
    app.UsePiranha(options => {
        options.UseCms();

        ...
    });
    
    ...
}
~~~

This call is equivalent to setting up the entire web application **and** adding the following middleware components (in the specified order). Please note that the integrated middleware handles a lot of different content types.

1. **Integrated** Middleware
2. **Sitemap** Middleware

## Middleware Routing

### Pages

`GET /<pageSlug>`

The middleware will rewrite requests to the specified **Page Type Route** or to `/page` if no route is specified, with the arguments `id` and `startpage`. To handle this request your **controller action** should look like this:

~~~ csharp
[Route("page")]
public IActionResult Page(Guid id, bool startpage)
{
    ...
}
~~~

### Posts

`GET /<archiveSlug>/<postSlug>`

The middleware will rewrite requests to the specified **Post Type Route** or to `/post` if no route is specified, with the argument `id`. To handle this request your controller action should look like this:

~~~ csharp
[Route("post")]
public IActionResult Post(Guid id)
{
    ...
}
~~~

### Archives

##### Standard Request

`GET /<archiveSlug>/<year?>/<month?>(/page/<pageNum>)?`

##### Filtered By Category

`GET /<archiveSlug>/category/<categorySlug>/<year?>/<month?>(/page/<pageNum>)?`

##### Filtered By Tag

`GET /<archiveSlug>/tag/<tagSlug>/<year?>/<month?>(/page/<pageNum>)?`

##### Possible Filters

All parameters are optional except `archiveSlug`, but the optional paging must be placed last. Everything after the page number is ignored. This means that the following URL's would be valid:

* `/myblog`
* `/myblog/category/fishing`
* `/myblog/tag/salmon`
* `/myblog/page/2`
* `/myblog/category/fishing/page/2`
* `/myblog/tag/salmon/page/2`
* `/myblog/2018`
* `/myblog/category/fishing/2018`
* `/myblog/tag/salmon/2018`
* `/myblog/2018/page/2`
* `/myblog/category/fishing/2018/page/2`
* `/myblog/tag/salmon/2018/page/2`
* `/myblog/2018/1`
* `/myblog/category/fishing/2018/1`
* `/myblog/tag/salmon/2018/1`
* `/myblog/2018/1/page/2`
* `/myblog/category/fishing/2018/1/page/2`
* `/myblog/tag/salmon/2018/1/page/2`

The middleware will rewrite requests to the specified route with the following arguments:

~~~ csharp
[Route("archive")]
public IActionResult Archive(Guid id, int? year = null, int? month = null,
    int? page = null, Guid? category = null, Guid? tag = null)
{
    ...
}
~~~

### Startpage

`GET /`

The start page middleware executes `api.Pages.GetStartpage()` which will load the page with `ParentId == null && SortOrder == 0` (i.e. the first root-level page in the site). The "start" page will then be handled the same as any other page.
